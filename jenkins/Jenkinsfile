pipeline {
    agent any
    
    environment {
        // Application Configuration
        WEB_APP_URL = 'http://localhost:5000'
        BASE_URL = 'http://localhost:5000'
        
        // Test Configuration
        TEST_DIR = 'selenium-tests'
        SCREENSHOTS_DIR = 'screenshots'
        REPORTS_DIR = 'reports'
        
        // Docker Configuration
        DOCKER_IMAGE = 'selenium-test-runner'
        DOCKER_CONTAINER = 'selenium-tests'
        
        // Email Configuration
        EMAIL_RECIPIENTS = 'devops@assignment.com, admin@assignment.com'
        EMAIL_SUBJECT = 'DevOps Assignment 3 - Test Results'
        
        // Git Configuration
        GIT_REPO = 'https://github.com/your-username/devops-assignment-3.git'
        GIT_BRANCH = 'main'
    }
    
    options {
        // Pipeline options
        timeout(time: 30, unit: 'MINUTES')
        timestamps()
        ansiColor('xterm')
        
        // Build options
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
    }
    
    triggers {
        // GitHub webhook trigger
        GenericTrigger(
            genericVariables: [
                [key: 'ref', value: '$.ref'],
                [key: 'repository', value: '$.repository.name'],
                [key: 'pusher', value: '$.pusher.name'],
                [key: 'commit_id', value: '$.head_commit.id'],
                [key: 'commit_message', value: '$.head_commit.message']
            ],
            causeString: 'Triggered by GitHub push',
            token: 'devops-assignment-3-webhook-token',
            regexpFilterText: '$ref',
            regexpFilterExpression: 'refs/heads/main'
        )
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "Starting DevOps Assignment 3 CI/CD Pipeline"
                    echo "Build Number: ${BUILD_NUMBER}"
                    echo "Build URL: ${BUILD_URL}"
                }
                
                // Checkout code from GitHub
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${GIT_BRANCH}"]],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [
                        [$class: 'CleanBeforeCheckout'],
                        [$class: 'CleanCheckout'],
                        [$class: 'SubmoduleOption', disableSubmodules: false, recursiveSubmodules: true, trackingSubmodules: false]
                    ],
                    submoduleCfg: [],
                    userRemoteConfigs: [[
                        url: "${GIT_REPO}",
                        credentialsId: 'github-credentials'
                    ]]
                ])
                
                script {
                    echo "Code checkout completed"
                    echo "Repository: ${GIT_REPO}"
                    echo "Branch: ${GIT_BRANCH}"
                    echo "Commit: ${env.GIT_COMMIT}"
                }
            }
        }
        
        stage('Environment Setup') {
            steps {
                script {
                    echo "Setting up test environment..."
                    
                    // Create necessary directories
                    sh '''
                        mkdir -p ${SCREENSHOTS_DIR}
                        mkdir -p ${REPORTS_DIR}
                        mkdir -p ${WORKSPACE}/logs
                    '''
                    
                    // Check Python and pip versions
                    sh '''
                        python3 --version
                        pip3 --version
                    '''
                    
                    // Install system dependencies
                    sh '''
                        sudo apt-get update -qq
                        sudo apt-get install -y -qq \
                            python3-pip \
                            python3-venv \
                            chromium-browser \
                            chromium-chromedriver \
                            wget \
                            curl
                    '''
                }
            }
        }
        
        stage('Web Application Setup') {
            steps {
                script {
                    echo "Setting up Flask web application..."
                    
                    dir('web-app') {
                        // Create virtual environment
                        sh '''
                            python3 -m venv venv
                            source venv/bin/activate
                            pip install --upgrade pip
                            pip install -r requirements.txt
                        '''
                        
                        // Start web application in background
                        sh '''
                            source venv/bin/activate
                            python app.py > ../logs/web-app.log 2>&1 &
                            echo $! > ../web-app.pid
                        '''
                        
                        // Wait for application to start
                        sh '''
                            sleep 10
                            curl -f http://localhost:5000/api/health || exit 1
                        '''
                        
                        echo "Web application started successfully"
                    }
                }
            }
        }
        
        stage('Test Dependencies') {
            steps {
                script {
                    echo "Installing test dependencies..."
                    
                    dir('selenium-tests') {
                        // Create virtual environment for tests
                        sh '''
                            python3 -m venv test-venv
                            source test-venv/bin/activate
                            pip install --upgrade pip
                            pip install -r requirements.txt
                        '''
                        
                        // Verify Selenium installation
                        sh '''
                            source test-venv/bin/activate
                            python -c "import selenium; print(f'Selenium version: {selenium.__version__}')"
                        '''
                    }
                }
            }
        }
        
        stage('Run Selenium Tests') {
            steps {
                script {
                    echo "Executing Selenium test suite..."
                    
                    dir('selenium-tests') {
                        // Set environment variables for tests
                        withEnv([
                            "BASE_URL=${WEB_APP_URL}",
                            "HEADLESS=true",
                            "SCREENSHOTS_DIR=${WORKSPACE}/${SCREENSHOTS_DIR}",
                            "REPORTS_DIR=${WORKSPACE}/${REPORTS_DIR}"
                        ]) {
                            // Run test suite
                            sh '''
                                source test-venv/bin/activate
                                python test_suite.py > ../logs/test-execution.log 2>&1
                            '''
                        }
                        
                        // Check test results
                        sh '''
                            if [ -f test_results.json ]; then
                                echo "Test results file found"
                                cat test_results.json
                            else
                                echo "No test results file found"
                                exit 1
                            fi
                        '''
                    }
                }
            }
            
            post {
                always {
                    script {
                        // Archive test artifacts
                        archiveArtifacts(
                            artifacts: "${SCREENSHOTS_DIR}/**/*, ${REPORTS_DIR}/**/*, logs/**/*, selenium-tests/test_results.json",
                            allowEmptyArchive: true
                        )
                        
                        // Publish test results
                        if (fileExists('selenium-tests/test_results.json')) {
                            publishJSON([
                                jsonPath: 'selenium-tests/test_results.json',
                                reportName: 'Selenium Test Results'
                            ])
                        }
                    }
                }
            }
        }
        
        stage('Docker Testing') {
            steps {
                script {
                    echo "Running tests in Docker container..."
                    
                    // Build Docker image for testing
                    sh '''
                        docker build -t ${DOCKER_IMAGE} -f docker/Dockerfile .
                    '''
                    
                    // Run tests in Docker container
                    sh '''
                        docker run --rm \
                            --name ${DOCKER_CONTAINER} \
                            --network host \
                            -v ${WORKSPACE}/${SCREENSHOTS_DIR}:/app/screenshots \
                            -v ${WORKSPACE}/${REPORTS_DIR}:/app/reports \
                            -e BASE_URL=${WEB_APP_URL} \
                            -e HEADLESS=true \
                            ${DOCKER_IMAGE}
                    '''
                }
            }
        }
        
        stage('Performance Testing') {
            steps {
                script {
                    echo "Running performance tests..."
                    
                    dir('selenium-tests') {
                        withEnv([
                            "BASE_URL=${WEB_APP_URL}",
                            "PERFORMANCE_THRESHOLD=3.0"
                        ]) {
                            sh '''
                                source test-venv/bin/activate
                                python -c "
import time
import requests
import json

base_url = '${BASE_URL}'
threshold = float('${PERFORMANCE_THRESHOLD}')

# Test page load times
pages = ['', '/login', '/register', '/api/health']
results = {}

for page in pages:
    start_time = time.time()
    try:
        response = requests.get(f'{base_url}{page}', timeout=10)
        load_time = time.time() - start_time
        results[page] = {
            'load_time': load_time,
            'status_code': response.status_code,
            'success': load_time < threshold
        }
        print(f'Page {page}: {load_time:.2f}s (Status: {response.status_code})')
    except Exception as e:
        results[page] = {
            'load_time': None,
            'error': str(e),
            'success': False
        }
        print(f'Page {page}: Error - {e}')

# Save performance results
with open('../reports/performance_results.json', 'w') as f:
    json.dump(results, f, indent=2)

# Check if all tests passed
all_passed = all(r.get('success', False) for r in results.values())
if not all_passed:
    exit(1)
"
                            '''
                        }
                    }
                }
            }
        }
        
        stage('Generate Reports') {
            steps {
                script {
                    echo "Generating comprehensive test reports..."
                    
                    // Generate HTML report
                    sh '''
                        cat > ${REPORTS_DIR}/test_report.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>DevOps Assignment 3 - Test Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background: #f0f0f0; padding: 20px; border-radius: 5px; }
        .summary { margin: 20px 0; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .pass { background: #d4edda; border: 1px solid #c3e6cb; }
        .fail { background: #f8d7da; border: 1px solid #f5c6cb; }
        .screenshot { max-width: 300px; margin: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>DevOps Assignment 3 - Test Report</h1>
        <p><strong>Build:</strong> ${BUILD_NUMBER}</p>
        <p><strong>Build URL:</strong> <a href="${BUILD_URL}">${BUILD_URL}</a></p>
        <p><strong>Timestamp:</strong> ${new Date().toISOString()}</p>
    </div>
    
    <div class="summary">
        <h2>Test Summary</h2>
        <p>This report contains the results of automated Selenium tests for the DevOps Assignment 3 web application.</p>
    </div>
    
    <div id="test-results">
        <!-- Test results will be populated here -->
    </div>
</body>
</html>
EOF
                    '''
                    
                    // Generate JSON summary
                    sh '''
                        cat > ${REPORTS_DIR}/summary.json << EOF
{
    "build_number": "${BUILD_NUMBER}",
    "build_url": "${BUILD_URL}",
    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "pipeline_status": "${currentBuild.result}",
    "test_suite": "DevOps Assignment 3",
    "total_tests": 14,
    "test_categories": [
        "Page Load Verification",
        "User Registration",
        "User Login",
        "Navigation",
        "Form Validation",
        "Database Operations",
        "Logout Functionality",
        "Error Messages",
        "UI Elements",
        "Responsive Design",
        "API Endpoints",
        "Performance Testing"
    ]
}
EOF
                    '''
                    
                    echo "Reports generated successfully"
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                script {
                    echo "Cleaning up test environment..."
                    
                    // Stop web application
                    sh '''
                        if [ -f web-app.pid ]; then
                            kill $(cat web-app.pid) 2>/dev/null || true
                            rm web-app.pid
                        fi
                    '''
                    
                    // Clean up Docker containers
                    sh '''
                        docker stop ${DOCKER_CONTAINER} 2>/dev/null || true
                        docker rm ${DOCKER_CONTAINER} 2>/dev/null || true
                    '''
                    
                    // Clean up temporary files
                    sh '''
                        rm -rf selenium-tests/test-venv
                        rm -rf web-app/venv
                    '''
                    
                    echo "Cleanup completed"
                }
            }
        }
    }
    
    post {
        always {
            script {
                // Always archive artifacts
                archiveArtifacts(
                    artifacts: "${SCREENSHOTS_DIR}/**/*, ${REPORTS_DIR}/**/*, logs/**/*",
                    allowEmptyArchive: true
                )
                
                // Record build information
                currentBuild.description = "DevOps Assignment 3 - Build ${BUILD_NUMBER}"
                
                echo "Pipeline execution completed"
            }
        }
        
        success {
            script {
                echo "Pipeline completed successfully!"
                
                // Send success notification
                emailext(
                    subject: "${EMAIL_SUBJECT} - SUCCESS",
                    body: """
                    <h2>DevOps Assignment 3 - Test Suite PASSED</h2>
                    <p><strong>Build Number:</strong> ${BUILD_NUMBER}</p>
                    <p><strong>Build URL:</strong> <a href="${BUILD_URL}">${BUILD_URL}</a></p>
                    <p><strong>Duration:</strong> ${currentBuild.durationString}</p>
                    <p><strong>Test Results:</strong> All tests passed successfully</p>
                    <p><strong>Screenshots:</strong> Available in build artifacts</p>
                    <p><strong>Reports:</strong> Available in build artifacts</p>
                    """,
                    to: "${EMAIL_RECIPIENTS}",
                    mimeType: 'text/html'
                )
            }
        }
        
        failure {
            script {
                echo "Pipeline failed!"
                
                // Send failure notification
                emailext(
                    subject: "${EMAIL_SUBJECT} - FAILED",
                    body: """
                    <h2>DevOps Assignment 3 - Test Suite FAILED</h2>
                    <p><strong>Build Number:</strong> ${BUILD_NUMBER}</p>
                    <p><strong>Build URL:</strong> <a href="${BUILD_URL}">${BUILD_URL}</a></p>
                    <p><strong>Duration:</strong> ${currentBuild.durationString}</p>
                    <p><strong>Failure Stage:</strong> ${currentBuild.description}</p>
                    <p><strong>Console Output:</strong> <a href="${BUILD_URL}console">View Console</a></p>
                    <p><strong>Test Results:</strong> Check build artifacts for details</p>
                    """,
                    to: "${EMAIL_RECIPIENTS}",
                    mimeType: 'text/html'
                )
            }
        }
        
        unstable {
            script {
                echo "Pipeline is unstable!"
                
                // Send unstable notification
                emailext(
                    subject: "${EMAIL_SUBJECT} - UNSTABLE",
                    body: """
                    <h2>DevOps Assignment 3 - Test Suite UNSTABLE</h2>
                    <p><strong>Build Number:</strong> ${BUILD_NUMBER}</p>
                    <p><strong>Build URL:</strong> <a href="${BUILD_URL}">${BUILD_URL}</a></p>
                    <p><strong>Duration:</strong> ${currentBuild.durationString}</p>
                    <p><strong>Status:</strong> Some tests failed or were unstable</p>
                    <p><strong>Test Results:</strong> Check build artifacts for details</p>
                    """,
                    to: "${EMAIL_RECIPIENTS}",
                    mimeType: 'text/html'
                )
            }
        }
    }
} 